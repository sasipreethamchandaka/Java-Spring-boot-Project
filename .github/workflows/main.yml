name: Full CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Checkout Code
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Setup Java 17
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3ï¸âƒ£ Build Spring Boot JAR
    - name: Build JAR
      working-directory: backend
      run: mvn clean package -DskipTests=true

    # 4ï¸âƒ£ Prepare EC2 Directory
    - name: Prepare EC2 App Directory
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          sudo mkdir -p /home/ec2-user/app
          sudo chown -R ec2-user:ec2-user /home/ec2-user/app

    # 5ï¸âƒ£ Upload New JAR
    - name: Upload JAR to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        source: "backend/target/datastore-0.0.7.jar"
        target: "/home/ec2-user/app/"
        overwrite: true

    # 6ï¸âƒ£ Stop Old Application (SAFE WAY)
    - name: Stop Old Application
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          PID=$(ps -ef | grep 'datastore-0.0.7.jar' | grep -v grep | awk '{print $2}')
          if [ -n "$PID" ]; then
            echo "Stopping old application PID=$PID"
            kill $PID
            sleep 5
          else
            echo "No existing application running"
          fi

    # 7ï¸âƒ£ Run New Application
    - name: Run Application on EC2
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          sudo mkdir -p /var/log/app
          sudo chown ec2-user:ec2-user /var/log/app

          cd /home/ec2-user/app

          nohup env \
            MYSQL_HOST=database-1.cde682sy68e9.us-east-1.rds.amazonaws.com \
            MYSQL_PORT=3306 \
            MYSQL_USERNAME=sasich \
            MYSQL_PASSWORD=sasich123 \
            LOG_FILE_PATH=/var/log/app/datastore.log \
            java -jar datastore-0.0.7.jar \
            --server.port=8084 \
            > /var/log/app/nohup.out 2>&1 &

          echo "ðŸš€ Application started successfully"
